#!/usr/bin/env sh

set -xe

build() {
  target="node8.6.0-$target_os"

  base_dir=$script_dir/..
  cd $base_dir

  app_version=$($script_dir/npm-pkg-version)

  full_target=ferret-$app_version-$target_os-$target_arch
  core_dist=$dist/$full_target
  mkdir -p $core_dist

  # need to include xdg-open
  mkdir -p $core_dist/node_modules/opn
  cp node_modules/opn/xdg-open $core_dist/node_modules/opn/xdg-open
  cp node_modules/opn/xdg-open $core_dist/xdg-open

  # need to hack include part of bundler-audit plugin until we make a rubygem
  mkdir -p $ruby_dist/node_modules/ferret-bundler-audit/lib_ruby
  cp -r node_modules/ferret-bundler-audit/lib_ruby/* $ruby_dist/node_modules/ferret-bundler-audit/lib_ruby/.

  bin_name="$core_dist/ferret"
  zip_name="$full_target.tgz"

  npx pkg -t $target -o $bin_name $pkg_json
  tar -C $core_dist/.. -czvf $core_dist/../$zip_name $full_target
}

clean() {
  npm run clean
  rm -rf $dist
  mkdir $dist

  npm run compile
}

main() {
  dist=dist
  script_dir=`dirname $0`
  pkg_json=build/package-bin.json
  target_arch=x86_64

  clean()

  target_os=linux
  build()

  target_os=win
  build()

  target_os=mac
  build()
}

main()
